<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CF Platform - Task Details</title>
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png" />
  <link rel="manifest" href="images/site.webmanifest" />
  <meta name="theme-color" content="#7494ec" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
        --primary-color: #4361ee;
        --primary-light: #4895ef;
        --primary-dark: #3f37c9;
        --secondary-color: #4cc9f0;
        --success-color: #4CAF50;
        --warning-color: #ff9800;
        --danger-color: #f44336;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --gray-color: #6c757d;
        --border-radius: 8px;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: #f5f7fb;
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        width: 100%;
    }

    /* Navbar */
    .navbar {
        background-color: white;
        box-shadow: var(--box-shadow);
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    .navbar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .nav-link {
        color: var(--dark-color);
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .nav-link:hover {
        color: var(--primary-color);
    }

    .nav-link.active {
        color: var(--primary-color);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
    }

    .user-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: var(--primary-light);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    /* Main Content */
    .main-content {
        flex: 1;
        padding: 30px 0;
    }

    .page-header {
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .page-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 5px;
    }

    .page-subtitle {
        color: var(--gray-color);
        font-size: 1rem;
    }

    /* Task Container */
    .task-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .task-header {
        padding: 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .task-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 10px;
    }

    .task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        color: var(--gray-color);
        font-size: 0.9rem;
    }

    .task-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .task-body {
        padding: 20px;
    }

    .task-content {
        white-space: pre-wrap;
        line-height: 1.6;
        padding: 20px;
        background: #f9f9f9;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
    }

    .solved-banner {
        background-color: rgba(76, 175, 80, 0.1);
        border-left: 4px solid var(--success-color);
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    /* Solution Form */
    .solution-form {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .solution-form-header {
        padding: 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .solution-form-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--dark-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .solution-form-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark-color);
    }

    .form-select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: var(--border-radius);
        font-size: 1rem;
        background-color: white;
        cursor: pointer;
        transition: var(--transition);
    }

    .form-select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .form-textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-family: 'Poppins', sans-serif;
        min-height: 200px;
        resize: vertical;
        transition: var(--transition);
    }

    .form-textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .file-upload {
        border: 2px dashed #e0e0e0;
        padding: 30px;
        text-align: center;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        cursor: pointer;
        transition: var(--transition);
    }

    .file-upload:hover {
        border-color: var(--primary-color);
    }

    .file-upload i {
        font-size: 2rem;
        color: var(--gray-color);
        margin-bottom: 10px;
    }

    .solution-form-footer {
        padding: 20px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
    }

    .btn {
        padding: 12px 20px;
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
    }

    .btn-outline {
        background-color: transparent;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-outline:hover {
        background-color: var(--primary-color);
        color: white;
    }

    .btn-success {
        background-color: var(--success-color);
        color: white;
    }

    .btn-success:hover {
        background-color: #3d8b40;
    }

    /* Loading and Error States */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 50px 0;
        text-align: center;
    }

    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error-container {
        background-color: #fdecea;
        border-left: 5px solid var(--danger-color);
        padding: 20px;
        border-radius: var(--border-radius);
        margin: 20px 0;
        color: #d32f2f;
    }

    /* Footer */
    .footer {
        background-color: white;
        padding: 30px 0;
        margin-top: auto;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .footer-logo {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .footer-links {
        display: flex;
        gap: 20px;
    }

    .footer-link {
        color: var(--gray-color);
        text-decoration: none;
        transition: var(--transition);
    }

    .footer-link:hover {
        color: var(--primary-color);
    }

    .footer-copyright {
        color: var(--gray-color);
        font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .navbar-container {
            flex-direction: column;
            gap: 15px;
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .solved-banner {
            flex-direction: column;
            align-items: flex-start;
        }

        .footer-content {
            flex-direction: column;
            text-align: center;
        }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container navbar-container">
        <a href="/profile.html" class="logo">
            <i class="fas fa-code"></i> CF Platform
        </a>
        <div class="nav-links">
            <a href="/profile.html" class="nav-link active">
                <i class="fas fa-tasks"></i> Tasks
            </a>
            <a href="/solutions.html" class="nav-link">
                <i class="fas fa-code"></i> My Solutions
            </a>
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="username">User</span>
            </div>
            <button class="btn btn-outline" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <div>
          <h1 class="page-title" id="taskTitle">Task Details</h1>
          <p class="page-subtitle">Solve the coding challenge below</p>
        </div>
        <button class="btn btn-outline" onclick="window.location.href='/profile.html'">
          <i class="fas fa-arrow-left"></i> Back to Tasks
        </button>
      </div>

      <div class="task-container" id="taskContainer">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Loading task details...</p>
        </div>
      </div>

      <div class="solution-form" id="solutionForm">
        <div class="solution-form-header">
          <h2 class="solution-form-title">
            <i class="fas fa-code"></i> Submit Your Solution
          </h2>
        </div>
        <div class="solution-form-body">
          <div class="form-group">
            <label class="form-label" for="language">Programming Language</label>
            <select class="form-select" id="language">
              <option value="cpp">C++</option>
              <option value="java">Java</option>
              <option value="python">Python</option>
              <option value="javascript">JavaScript</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Solution Code</label>
            <div class="file-upload" id="fileUpload">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Drag and drop your code file here or click to browse</p>
              <input type="file" id="codeFile" style="display: none;" />
            </div>
            <p>Or enter your code manually:</p>
            <textarea class="form-textarea" id="codeInput" placeholder="Enter your code here..."></textarea>
          </div>
        </div>
        <div class="solution-form-footer">
          <button class="btn btn-primary" onclick="submitSolution()">
            <i class="fas fa-paper-plane"></i> Submit Solution
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer-content">
        <div class="footer-logo">
            <i class="fas fa-code"></i> CF Platform
        </div>
        <div class="footer-links">
            <a href="javascript:void(0);" onclick="showAbout()" class="footer-link">About</a>
            <a href="javascript:void(0);" onclick="showContact()" class="footer-link">Contact</a>
            <a href="javascript:void(0);" onclick="showPrivacyPolicy()" class="footer-link">Privacy Policy</a>
        </div>
        <div class="footer-copyright">
            &copy; 2023 CF Platform. All rights reserved.
        </div>
    </div>
  </footer>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get("id");

    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      const user = JSON.parse(localStorage.getItem('user'));
      const token = localStorage.getItem('token');

      if (!user || !token) {
        window.location.href = '/';
        return;
      }

      // Set user name in the navbar
      document.getElementById('username').textContent = user.username || user.email;

      // Load task details
      await loadTask();

      // Set up file upload event listeners
      setupFileUpload();
    });

    // Load task details from the server
    async function loadTask() {
      try {
        showLoadingState();

        const taskResponse = await fetch(`/api/tasks/${taskId}`, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
            Accept: "application/json",
          },
        });

        if (!taskResponse.ok) {
          const errorData = await taskResponse.json().catch(() => ({}));
          throw new Error(errorData.error || "Error loading task");
        }

        const task = await taskResponse.json();

        // Update page title
        document.getElementById("taskTitle").textContent = task.title || "Task Details";
        document.title = `CF Platform - ${task.title || "Task"}`;

        // Build task container HTML
        const taskContainer = document.getElementById("taskContainer");
        taskContainer.innerHTML = `
          <div class="task-header">
            <h2 class="task-title">${escapeHtml(task.title || "Untitled Task")}</h2>
            <div class="task-meta">
              <div class="task-meta-item">
                <i class="fas fa-code"></i> ${getLanguageName(task.language)}
              </div>
              <div class="task-meta-item">
                <i class="fas fa-signal"></i> Difficulty: ${getDifficultyLabel(task.difficulty || 'medium')}
              </div>
            </div>
          </div>
          <div class="task-body">
            <div class="task-content">
              ${escapeHtml(task.content || "The problem statement is missing")}
            </div>
          </div>
        `;

        // Check if the task is already solved
        const solvedResponse = await fetch(`/api/check-solved?task_id=${taskId}`, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
            Accept: "application/json",
          },
        });

        if (solvedResponse.ok) {
          const isSolved = await solvedResponse.json();
          if (isSolved.solved) {
            const taskBody = taskContainer.querySelector('.task-body');
            const solvedBannerHTML = `
              <div class="solved-banner">
                <div>
                  <i class="fas fa-check-circle" style="color: var(--success-color); margin-right: 8px;"></i>
                  <strong>Congratulations!</strong> You have already solved this problem.
                </div>
                <button class="btn btn-success" onclick="window.location.href='/solution-detail.html?id=${isSolved.solution_id}'">
                  <i class="fas fa-eye"></i> View Your Solution
                </button>
              </div>
            `;
            taskBody.insertAdjacentHTML("afterbegin", solvedBannerHTML);
          }
        }
      } catch (error) {
        console.error("Error loading task:", error);
        showErrorState(error.message || "Failed to load task");
      }
    }

    // Submit solution to the server
    async function submitSolution() {
      const language = document.getElementById("language").value;
      const code = document.getElementById("codeInput").value;

      if (!code.trim()) {
        alert("Please enter your code or upload a file");
        return;
      }

      try {
        // Show loading state
        const submitButton = document.querySelector('.solution-form-footer .btn');
        const originalButtonText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitButton.disabled = true;

        const user = JSON.parse(localStorage.getItem("user"));
        const response = await fetch("/api/submissions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          body: JSON.stringify({
            task_id: taskId,
            language,
            code,
            user_id: user.id,
          }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Error submitting solution");

        // Update local storage to mark task as solved
        const solvedTasks = JSON.parse(localStorage.getItem("solvedTasks")) || {};
        solvedTasks[taskId] = true;
        localStorage.setItem("solvedTasks", JSON.stringify(solvedTasks));

        // Show success message
        showSuccessMessage(data.id);
      } catch (error) {
        console.error("Error submitting solution:", error);

        // Show error message
        const formBody = document.querySelector('.solution-form-body');
        const errorHTML = `
          <div class="error-container" style="margin-bottom: 20px;">
            <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
            <p>${error.message || "Failed to submit solution"}</p>
          </div>
        `;
        formBody.insertAdjacentHTML("afterbegin", errorHTML);

        // Reset button
        const submitButton = document.querySelector('.solution-form-footer .btn');
        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Solution';
        submitButton.disabled = false;
      }
    }

    // Show success message after submission
    function showSuccessMessage(solutionId) {
      const solutionForm = document.getElementById('solutionForm');
      solutionForm.innerHTML = `
        <div style="padding: 40px 20px; text-align: center;">
          <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success-color); margin-bottom: 20px;"></i>
          <h2 style="margin-bottom: 15px;">Solution Submitted Successfully!</h2>
          <p style="margin-bottom: 30px;">Your solution has been sent for review. You can check its status in your solutions list.</p>
          <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="window.location.href='/solution-detail.html?id=${solutionId}'">
              <i class="fas fa-eye"></i> View Solution
            </button>
            <button class="btn btn-outline" onclick="window.location.href='/profile.html'">
              <i class="fas fa-tasks"></i> Back to Tasks
            </button>
          </div>
        </div>
      `;

      // Reload the task to show the solved banner
      loadTask();
    }

    // Set up file upload functionality
    function setupFileUpload() {
      document.getElementById("fileUpload").addEventListener("click", () => {
        document.getElementById("codeFile").click();
      });

      document.getElementById("codeFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById("codeInput").value = event.target.result;
          };
          reader.readAsText(file);
        }
      });

      const fileUpload = document.getElementById("fileUpload");

      fileUpload.addEventListener("dragover", (e) => {
        e.preventDefault();
        fileUpload.style.borderColor = "var(--primary-color)";
        fileUpload.style.backgroundColor = "rgba(67, 97, 238, 0.05)";
      });

      fileUpload.addEventListener("dragleave", () => {
        fileUpload.style.borderColor = "#e0e0e0";
        fileUpload.style.backgroundColor = "transparent";
      });

      fileUpload.addEventListener("drop", (e) => {
        e.preventDefault();
        fileUpload.style.borderColor = "#e0e0e0";
        fileUpload.style.backgroundColor = "transparent";

        const file = e.dataTransfer.files[0];
        if (file && file.name.match(/\.(cpp|java|py|js)$/i)) {
          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById("codeInput").value = event.target.result;
          };
          reader.readAsText(file);
        } else {
          alert("Please upload a valid code file (.cpp, .java, .py, .js)");
        }
      });
    }

    // Show loading state
    function showLoadingState() {
      document.getElementById('taskContainer').innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Loading task details...</p>
        </div>
      `;
    }

    // Show error state
    function showErrorState(message) {
      document.getElementById('taskContainer').innerHTML = `
        <div class="error-container">
          <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
          <p>${message}</p>
          <div style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="loadTask()">
              <i class="fas fa-sync"></i> Try Again
            </button>
            <button class="btn btn-outline" onclick="window.location.href='/profile.html'" style="margin-left: 10px;">
              <i class="fas fa-arrow-left"></i> Back to Tasks
            </button>
          </div>
        </div>
      `;
    }

    // Get human-readable language name
    function getLanguageName(code) {
      const languages = {
        'cpp': 'C++',
        'python': 'Python',
        'java': 'Java',
        'javascript': 'JavaScript'
      };
      return languages[code] || code || 'Multiple';
    }

    // Get difficulty label
    function getDifficultyLabel(difficulty) {
      const labels = {
        'easy': 'Easy',
        'medium': 'Medium',
        'hard': 'Hard'
      };
      return labels[difficulty.toLowerCase()] || 'Medium';
    }

    // Escape HTML to prevent XSS
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Footer information functions
    function showAbout() {
      alert('CF Platform is a coding challenge platform designed to help developers improve their programming skills through practice problems and challenges.');
    }

    function showContact() {
      alert('For any questions or support, please contact us at support@cfplatform.com');
    }

    function showPrivacyPolicy() {
      alert('CF Platform respects your privacy. We do not share your personal information with third parties without your consent.');
    }

    // Logout function
    function logout() {
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      localStorage.removeItem('solvedTasks');
      window.location.href = '/';
    }
  </script>
</body>
</html>
